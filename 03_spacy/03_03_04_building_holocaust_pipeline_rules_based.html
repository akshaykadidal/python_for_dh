
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>3.3. Creating Rules-Based Pipeline for Holocaust Documents &#8212; Introduction to Python for Humanists</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1. Topic Modeling: Concepts and Theory" href="../04_topic_modeling/04_01_01_intro.html" />
    <link rel="prev" title="3.2. The Challenges of Holocaust NER" href="03_03_03_challenges.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/chapman-logo.jpg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Introduction to Python for Humanists</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    <p align="center">INTRODUCTION TO PYTHON FOR HUMANISTS</p>
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PREFACE
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../00_preface/00_01_preface.html">
   1. Preface
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PART ONE: The Basics of Python
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01_intro/01_01-01_intro.html">
   1. Introduction to Python
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_01-02_introduction_to_python.html">
     1.1. What is Python?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_01-03_installing_python.html">
     1.2. Installing Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_01-04_coding_basics.html">
     1.3. Coding Basics
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01_intro/01_02-01_intro.html">
   2. Working with Data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_02-02_data.html">
     2.1. Data Types
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_02-03_data_structures.html">
     2.2. Data Structures
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01_intro/01_03-01_intro.html">
   3. Loops and Logic
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_03-02_loops.html">
     3.1. Introduction to Loops
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_03-03_conditionals.html">
     3.2. Introduction to Conditionals
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01_intro/01_04-01_intro.html">
   4. Formal Coding: Functions, Classes, and Libraries
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_04-02_functions.html">
     4.1. Introduction to Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_04-03_classes.html">
     4.2. Introduction to Classes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_04-04_libraries.html">
     4.3. Introduction to Libraries
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01_intro/01_05-01_intro.html">
   5. Working with External Data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_05-02_texts.html">
     5.1. Loading and Saving Text Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_05-03_json.html">
     5.2. Loading and Saving JSON Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_05-04_multiple_files.html">
     5.3. Working with Multiple Files
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01_intro/01_06-01_intro.html">
   6. Working with Data on the Web
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_06-02_html.html">
     6.1. Parsing HTML with Python and BeautifulSoup
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01_intro/01_06-03_scraping_pages.html">
     6.2. Scraping Web Pages with Requests and BeautifulSoup
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PART TWO: Data Analysis with Pandas (Work in Progress)
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02_pandas/02_01_01_intro.html">
   1. Introduction to Pandas
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_01_02_introduction_to_pandas.html">
     1.1. What is Pandas?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_01_03_the_basics.html">
     1.2. The Basics of Pandas
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02_pandas/02_02_01_intro.html">
   2. Working with Data in Pandas
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_02_02_finding_data.html">
     2.1. Finding Data in a DataFrame
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_02_03_organizing_data.html">
     2.2. Organizing Data in Pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_02_04_cleaning_data.html">
     2.3. Cleaning Data with Pandas
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02_pandas/02_03_01_intro.html">
   3. Searching for Data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_03_02_advanced_strings.html">
     3.1. Advanced Searching on Strings in DataFrame
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_03_03_advanced_querying.html">
     3.2. Advanced Filtering and Querying
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_03_04_advanced_grouping.html">
     3.3. Advanced Grouping with Groupby
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02_pandas/02_04_01_intro.html">
   4. Advanced Pandas
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_04_02_pandas_and_plots.html">
     4.1. Basic Plotting with Pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_04_03_graphing_networks_with_pandas.html">
     4.2. Graphing Network Data from Pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_pandas/02_04_04_time_series_data.html">
     4.3. Introduction to Time Series Data
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PART THREE: Natural Language Processing with spaCy
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="03_01_01_intro.html">
   1. Introduction to spaCy
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="03_01_02_install_and_containers.html">
     1.1. The Basics of spaCy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_01_03_linguistic_annotations.html">
     1.2. spaCy Linguistic Annotations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_01_04_pipelines.html">
     1.3. spaCy Pipelines
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="03_02_01_intro.html">
   2. Rules-Based spaCy
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="03_02_02_entityruler.html">
     2.1. How to use the spaCy EntityRuler
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_02_03_matcher.html">
     2.2. How to use the spaCy Matcher
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_02_04_phrase_matcher.html">
     2.3. How to use the spaCy PhraseMatcher
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_02_06_simple_regex.html">
     2.4. How to use RegEx in spaCy (Basic)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_02_07_complex_regex.html">
     2.5. How to use RegEx in spaCy (Advanced)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="03_03_01_intro.html">
   3. Solving a Domain-Specific Problem: A Case Study with Holocaust NER
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="03_03_02_cultivating_concentration_camp_dataset.html">
     3.1. Cultivating Good Datasets for Entities
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_03_03_challenges.html">
     3.2. The Challenges of Holocaust NER
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     3.3. Creating the Rules-Based Pipeline
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PART FOUR: OTHER APPLICATIONS OF PYTHON
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../04_topic_modeling/04_01_01_intro.html">
   1. Topic Modeling in Python
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../04_topic_modeling/04_01_02_topic_modeling_concepts.html">
     1.2. What is Topic Modeling?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04_topic_modeling/04_01_03_clusters.html">
     1.3. Topics and Clusters
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04_topic_modeling/04_01_04_bigrams.html">
     1.4. Bigrams and Trigrams
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04_topic_modeling/04_02_02_lda_concept.html">
     1.5. What is LDA Topic Modeling?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04_topic_modeling/04_02_03_tfidf.html">
     1.6. TF-IDF
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04_topic_modeling/04_02_04_scikit_learn.html">
     1.7. Scikit Learn
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04_topic_modeling/04_02_05_tfidf_build.html">
     1.8. TF-IDF with Scikit Learn
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04_topic_modeling/04_03_03_embedding_clustering.html">
     1.9. Embedding, Flattening, and Clustering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04_topic_modeling/04_03_04_top2vec.html">
     1.10. Top2Vec in Python
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../08_booknlp/01_01_intro.html">
   2. Text Analysis with BookNLP
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
  <label for="toctree-checkbox-15">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../08_booknlp/01_intro.html">
     2.1. Introduction to BookNLP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08_booknlp/02_starting.html">
     2.2. Getting Started with BookNLP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08_booknlp/03_files.html">
     2.3. The Output Files
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08_booknlp/04_character_analysis.html">
     2.4. Character Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08_booknlp/05_events.html">
     2.5. Events Analysis
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../06_sna/06_01_01_intro.html">
   3. Social Network Analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
  <label for="toctree-checkbox-16">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../06_sna/06_01_02_basics.html">
     3.1. The Basic Concepts of Social Network Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06_sna/06_01_03_networkx.html">
     3.2. Introduction to NetworkX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06_sna/06_01_04_pyvis_basics.html">
     3.3. Producing Dynamic Graphs with PyVis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06_sna/06_01_05_networkx_pyvis.html">
     3.4. NetworkX and PyVis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06_sna/06_01_06_node_color.html">
     3.5. Adding Color to Nodes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06_sna/06_01_07_applied.html">
     3.6. SNA on Humanities Data
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PART FIVE: DESIGNING AN APPLICATION WITH STREAMLIT
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../05_streamlit/05_01_01_intro.html">
   1. Introduction to Streamlit
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
  <label for="toctree-checkbox-17">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_01_02_streamlit.html">
     1.1. Creating Our First App
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_01_03_displaying_data.html">
     1.2. Displaying Data in Streamlit
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_01_04_input_widgets.html">
     1.3. Streamlit Input Widgets
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../05_streamlit/05_02_01_intro.html">
   2. Advanced Streamlit Features
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
  <label for="toctree-checkbox-18">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_02_02_charts.html">
     2.1. Data Visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_02_03_layout_design.html">
     2.2. Layout Design
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_02_04_cache.html">
     2.3. Streamlit Cache and Session States
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_02_05_custom_html.html">
     2.5. Custom HTML
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_02_06_multiple_pages.html">
     2.6. Multi-Page Applications
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../05_streamlit/05_03_01_intro.html">
   3. Building a Database Query Application
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/>
  <label for="toctree-checkbox-19">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_03_02_database_query_app.html">
     3.1. Building a Database Query Application
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../05_streamlit/05_03_03_cloud.html">
     3.2. Deploying an App in the Cloud with Streamlit Share
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/wjbmattingly/python_for_dh/main?urlpath=tree/03_spacy/03_03_04_building_holocaust_pipeline_rules_based.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/wjbmattingly/python_for_dh/blob/main/03_spacy/03_03_04_building_holocaust_pipeline_rules_based.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/wjbmattingly/python_for_dh"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/wjbmattingly/python_for_dh/issues/new?title=Issue%20on%20page%20%2F03_spacy/03_03_04_building_holocaust_pipeline_rules_based.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/wjbmattingly/python_for_dh/edit/main/03_spacy/03_03_04_building_holocaust_pipeline_rules_based.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/03_spacy/03_03_04_building_holocaust_pipeline_rules_based.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-blank-spacy-model">
   3.3.1. Creating a Blank spaCy Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-entityrulers">
   3.3.2. Creating EntityRulers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-function-for-matching-regex">
   3.3.3. Creating Function for Matching RegEx
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-pipe-for-finding-streets">
   3.3.4. Add Pipe for Finding Streets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-pipe-for-finding-ships">
   3.3.5. Creating a Pipe for Finding Ships
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-pipe-for-identifying-a-military-personnel">
   3.3.6. Create Pipe for Identifying a Military Personnel
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-pipe-for-identifying-spouses">
   3.3.7. Create Pipe for Identifying Spouses
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-pipe-for-finding-ghettos">
   3.3.8. Creating a Pipe for Finding Ghettos
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-geography-pipe">
   3.3.9. Creating a Geography Pipe
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#seeing-the-pipes-at-work">
   3.3.10. Seeing the Pipes at Work
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1><center>Creating Rules-Based Pipeline for Holocaust Documents</center></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-blank-spacy-model">
   3.3.1. Creating a Blank spaCy Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-entityrulers">
   3.3.2. Creating EntityRulers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-function-for-matching-regex">
   3.3.3. Creating Function for Matching RegEx
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-pipe-for-finding-streets">
   3.3.4. Add Pipe for Finding Streets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-pipe-for-finding-ships">
   3.3.5. Creating a Pipe for Finding Ships
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-pipe-for-identifying-a-military-personnel">
   3.3.6. Create Pipe for Identifying a Military Personnel
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-pipe-for-identifying-spouses">
   3.3.7. Create Pipe for Identifying Spouses
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-pipe-for-finding-ghettos">
   3.3.8. Creating a Pipe for Finding Ghettos
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-geography-pipe">
   3.3.9. Creating a Geography Pipe
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#seeing-the-pipes-at-work">
   3.3.10. Seeing the Pipes at Work
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="center-creating-rules-based-pipeline-for-holocaust-documents-center">
<h1><span class="section-number">3.3. </span><center>Creating Rules-Based Pipeline for Holocaust Documents</center><a class="headerlink" href="#center-creating-rules-based-pipeline-for-holocaust-documents-center" title="Permalink to this headline">#</a></h1>
<p>In this section, we will walk through how to develop a complete heuristic spaCy pipeline for performing named entity recognition. We will leverage a combination of EntityRuler pipes and custom spaCy pipes that use RegEx to find larger matches.</p>
<section id="creating-a-blank-spacy-model">
<h2><span class="section-number">3.3.1. </span>Creating a Blank spaCy Model<a class="headerlink" href="#creating-a-blank-spacy-model" title="Permalink to this headline">#</a></h2>
<p>The first thing we need to do is import all of the different components from spaCy and other libraries that we will need. I will explain these as we go forward.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">from</span> <span class="nn">spacy.util</span> <span class="kn">import</span> <span class="n">filter_spans</span>
<span class="kn">from</span> <span class="nn">spacy.tokens</span> <span class="kn">import</span> <span class="n">Span</span>
<span class="kn">from</span> <span class="nn">spacy.language</span> <span class="kn">import</span> <span class="n">Language</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">unidecode</span>
<span class="kn">from</span> <span class="nn">spacy</span> <span class="kn">import</span> <span class="n">displacy</span>
</pre></div>
</div>
</div>
</div>
<p>We will be using Pandas in this notebook to run data checks in a CSV file originally produced by the <a href="https://holocaustgeographies.org/">Holocaust Geographies Collaborative</a>, headed by Anne Knowles, Tim Cole, Alberto Giordano, Paul Jaskot, and Anika Walke. We will be importing RegEx because a lot of our heuristics will rely on capturing multi-word tokens.</p>
<p>Now that we have imported everything, let’s create a blank English pipeline in spaCy. As we work through this notebook, we will add pipes to it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="creating-entityrulers">
<h2><span class="section-number">3.3.2. </span>Creating EntityRulers<a class="headerlink" href="#creating-entityrulers" title="Permalink to this headline">#</a></h2>
<p>In the first section of this chapter, we looked at acquiring a camps dataset from the USHMM website. We will now build off that section by normalizing our dataset to include camp names with and without accent marks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ushmm_camps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Alderney&#39;</span><span class="p">,</span> <span class="s1">&#39;Amersfoort&#39;</span><span class="p">,</span> <span class="s1">&#39;Auschwitz&#39;</span><span class="p">,</span> <span class="s1">&#39;Banjica&#39;</span><span class="p">,</span> <span class="s1">&#39;Bełżec&#39;</span><span class="p">,</span> <span class="s1">&#39;Bergen-Belsen&#39;</span><span class="p">,</span> <span class="s1">&#39;Bernburg&#39;</span><span class="p">,</span> <span class="s1">&#39;Bogdanovka&#39;</span><span class="p">,</span> <span class="s1">&#39;Bolzano&#39;</span><span class="p">,</span> <span class="s1">&#39;Bor&#39;</span><span class="p">,</span> <span class="s1">&#39;Breendonk&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Breitenau&#39;</span><span class="p">,</span> <span class="s1">&#39;Buchenwald&#39;</span><span class="p">,</span> <span class="s1">&#39;Chełmno&#39;</span><span class="p">,</span> <span class="s1">&#39;Dachau&#39;</span><span class="p">,</span> <span class="s1">&#39;Drancy&#39;</span><span class="p">,</span> <span class="s1">&#39;Falstad&#39;</span><span class="p">,</span> <span class="s1">&#39;Flossenbürg&#39;</span><span class="p">,</span> <span class="s1">&#39;Fort VII&#39;</span><span class="p">,</span> <span class="s1">&#39;Fossoli&#39;</span><span class="p">,</span> <span class="s1">&#39;Grini&#39;</span><span class="p">,</span> <span class="s1">&#39;Gross-Rosen&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Herzogenbusch&#39;</span><span class="p">,</span> <span class="s1">&#39;Hinzert&#39;</span><span class="p">,</span> <span class="s1">&#39;Janowska&#39;</span><span class="p">,</span> <span class="s1">&#39;Jasenovac&#39;</span><span class="p">,</span> <span class="s1">&#39;Kaiserwald&#39;</span><span class="p">,</span> <span class="s1">&#39;Kaunas&#39;</span><span class="p">,</span> <span class="s1">&#39;Kemna&#39;</span><span class="p">,</span> <span class="s1">&#39;Klooga&#39;</span><span class="p">,</span> <span class="s1">&#39;Le Vernet&#39;</span><span class="p">,</span> <span class="s1">&#39;Majdanek&#39;</span><span class="p">,</span> <span class="s1">&#39;Malchow&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Maly Trostenets&#39;</span><span class="p">,</span> <span class="s1">&#39;Mechelen&#39;</span><span class="p">,</span> <span class="s1">&#39;Mittelbau-Dora&#39;</span><span class="p">,</span> <span class="s1">&#39;Natzweiler-Struthof&#39;</span><span class="p">,</span> <span class="s1">&#39;Neuengamme&#39;</span><span class="p">,</span> <span class="s1">&#39;Niederhagen&#39;</span><span class="p">,</span> <span class="s1">&#39;Oberer Kuhberg&#39;</span><span class="p">,</span> <span class="s1">&#39;Oranienburg&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Osthofen&#39;</span><span class="p">,</span> <span class="s1">&#39;Płaszów&#39;</span><span class="p">,</span> <span class="s1">&#39;Ravensbruck&#39;</span><span class="p">,</span> <span class="s1">&#39;Risiera di San Sabba&#39;</span><span class="p">,</span> <span class="s1">&#39;Sachsenhausen&#39;</span><span class="p">,</span> <span class="s1">&#39;Sajmište&#39;</span><span class="p">,</span> <span class="s1">&#39;Salaspils&#39;</span><span class="p">,</span> <span class="s1">&#39;Sobibór&#39;</span><span class="p">,</span> <span class="s1">&#39;Soldau&#39;</span><span class="p">,</span> <span class="s1">&#39;Stutthof&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Theresienstadt&#39;</span><span class="p">,</span> <span class="s1">&#39;Trawniki&#39;</span><span class="p">,</span> <span class="s1">&#39;Treblinka&#39;</span><span class="p">,</span> <span class="s1">&#39;Vaivara&#39;</span><span class="p">]</span>

<span class="n">camp_patterns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">camp</span> <span class="ow">in</span> <span class="n">ushmm_camps</span><span class="p">:</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">unidecode</span><span class="o">.</span><span class="n">unidecode</span><span class="p">(</span><span class="n">camp</span><span class="p">)</span>
    <span class="n">camp_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="n">camp</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;CAMP&quot;</span><span class="p">})</span>
    <span class="n">camp_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="n">normalized</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;CAMP&quot;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Note that we are creating a list called <code class="docutils literal notranslate"><span class="pre">camp_patterns</span></code>. These are a set of patterns expected by a spaCy EntityRuler. With our patterns created, we can create our EntityRuler. Note that we are placing the ruler before the NER pipe in the model. This is so that our heuristic EntityRuler will be able to annotate the doc container before the NER model. We are also giving it a custom name, <code class="docutils literal notranslate"><span class="pre">camp_ruler</span></code>. This is so that we know precisely what this ruler does in our pipeline when we examine the pipeline structure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">camp_ruler</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;entity_ruler&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;camp_ruler&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With the ruler created, we can then populate it with the patterns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">camp_ruler</span><span class="o">.</span><span class="n">add_patterns</span><span class="p">(</span><span class="n">camp_patterns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, it is time to test the pipeline to make sure it is working as intended.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="s2">&quot;Auschwitz was a camp during WWII. Płaszów was also a camp. Another spelling is Plaszow.&quot;</span><span class="p">)</span>
<span class="n">displacy</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;ent&quot;</span><span class="p">,</span> <span class="n">jupyter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span class="tex2jax_ignore"><div class="entities" style="line-height: 2.5; direction: ltr">
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Auschwitz
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">CAMP</span>
</mark>
 was a camp during 
<mark class="entity" style="background: #ffeb80; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    WWII
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">EVENT</span>
</mark>
. 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Płaszów
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">CAMP</span>
</mark>
 was also a camp. Another spelling is 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Plaszow
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">CAMP</span>
</mark>
.</div></span></div></div>
</div>
<p>Note that our pipeline is now correctly identifying all forms of camps as camps correctly. This will ensure that our pipeline can function with different spellings of these words.</p>
</section>
<section id="creating-function-for-matching-regex">
<h2><span class="section-number">3.3.3. </span>Creating Function for Matching RegEx<a class="headerlink" href="#creating-function-for-matching-regex" title="Permalink to this headline">#</a></h2>
<p>As noted in the previous section, one of the main challenges with Holocaust-related data is the high degree of toponyms, or words that have identical spelling but different classifications. We will see this issue with several of our classes. Many US ships, for example, bear the name of states. Additionally, named ghettos, such as the Warsaw Ghetto, also can function as a general place (GPE). If we want to use heuristics, therefore, we must create rather robust rules to ensure that our rules have a high degree of accuracy. We can use the following function to do just that by leveraging RegEx.</p>
<p>We will be using this function quite a bit for each of our custom spaCy pipes, so let’s explore this function in depth.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">context_list</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">window_start</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">window_end</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">text</span>
    <span class="n">new_ents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">original_ents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
        <span class="n">span</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">char_span</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="o">-</span><span class="n">window_start</span><span class="p">:</span><span class="n">end</span><span class="o">+</span><span class="n">window_end</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">term</span> <span class="ow">in</span> <span class="n">window</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">context_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_ents</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">span</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_ents</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">span</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">new_ents</span><span class="p">:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">ent</span>
        <span class="n">new_ent</span> <span class="o">=</span> <span class="n">Span</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="n">original_ents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_ent</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">filter</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">filter_spans</span><span class="p">(</span><span class="n">original_ents</span><span class="p">)</span>
        <span class="n">final_ents</span> <span class="o">=</span> <span class="n">filtered</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_ents</span> <span class="o">=</span> <span class="n">new_ents</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">ents</span> <span class="o">=</span> <span class="n">final_ents</span>
    <span class="k">return</span> <span class="n">doc</span>
</pre></div>
</div>
</div>
</div>
<p>def The purpose of this function is to leverage RegEx and spaCy to perform full-text matching. This allows us to use the strengths of both NLP techniques. With RegEx, we can perform complex fuzzy string matching beyond an individual token. With spaCy, we can leverage linguistic knowledge about the text. This function will let us pass a RegEx pattern, a doc container, and a custom label, then find all items that match the pattern. It will then inject those RegEx matches into spaCy <code class="docutils literal notranslate"><span class="pre">Span</span></code> containers that will then be manually inserted into the found entities. Let’s break this down in the code.</p>
<p>The first line of our code is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">The</span> <span class="n">context_list</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">window_start</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">window_end</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</pre></div>
</div>
<p>Here, we are creating a function that will take three mandatory arguments: <code class="docutils literal notranslate"><span class="pre">doc</span></code>, <code class="docutils literal notranslate"><span class="pre">pattern</span></code>, and <code class="docutils literal notranslate"><span class="pre">label</span></code>. The <code class="docutils literal notranslate"><span class="pre">doc</span></code> parameter will be the Doc container that is created by the spaCy nlp pipeline. The <code class="docutils literal notranslate"><span class="pre">pattern</span></code> will be the RegEx pattern that we want to use to perform a match. Finally, the <code class="docutils literal notranslate"><span class="pre">label</span></code> is the label that we want to assign to the items matched.</p>
<p>We also have several keyword arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">filter</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">context_list</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">window_start</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">window_end</span></code></p></li>
</ul>
<p>These keyword arguments allow for greater versatility in the function. It allows a user to filter the entities and only keep the ones that are longest. Remember, spaCy entities are hard classifications, meaning a token can only belong to a single class, or label. This ensures that when we manually place our found RegEx matches into the Doc container’s entities, there are no overlapping entities.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">context</span></code> parameter is a Boolean that allows for a user to pass a <code class="docutils literal notranslate"><span class="pre">context_list</span></code> to the function. This will be a list of words that increases the propability that an identified token belongs to a specific class. We will see this at play when we write rules for the labels <code class="docutils literal notranslate"><span class="pre">GHETTO</span></code> and <code class="docutils literal notranslate"><span class="pre">SHIP</span></code>. As noted above, ghettos frequently function as <code class="docutils literal notranslate"><span class="pre">GHETTO</span></code> and <code class="docutils literal notranslate"><span class="pre">GPE</span></code>. The presence of certain words around a match, such as <code class="docutils literal notranslate"><span class="pre">ghetto</span></code>, radically increase the chance that our hit is a <code class="docutils literal notranslate"><span class="pre">GHETTO</span></code> and not a <code class="docutils literal notranslate"><span class="pre">GPE</span></code>. Likewise, with ships, many ships in the US fleet are named after states. This means we could potentially mark New York, for example, as a <code class="docutils literal notranslate"><span class="pre">SHIP</span></code>, rather than as a <code class="docutils literal notranslate"><span class="pre">GPE</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">window_start</span></code> and <code class="docutils literal notranslate"><span class="pre">window_end</span></code> control the window of the context. So it will only look forward and backward n-characters for the presence of a word in the <code class="docutils literal notranslate"><span class="pre">context_list</span></code>. This is a simple heuristic but one that proves quite effective.</p>
<p>The next bit of code is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">text</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">text</span>
    <span class="n">new_ents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">original_ents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we are grabbing the raw text of the Doc container. This will be necessary if the user has enabled context searching. Next, we create an empty list of new entities. This will be the list to which we append our new hits. Finally, we grab the original entities already found by earlier pipes. It is important to convert this to a list because <code class="docutils literal notranslate"><span class="pre">doc.ents</span></code> is a generator which prevents us from iterating over the data.</p>
<p>The next block of code looks like this</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
        <span class="n">span</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">char_span</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="o">-</span><span class="n">window_start</span><span class="p">:</span><span class="n">end</span><span class="o">+</span><span class="n">window_end</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">term</span> <span class="ow">in</span> <span class="n">window</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">context_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_ents</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">span</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_ents</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">span</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
</pre></div>
</div>
<p>Here, we are using <code class="docutils literal notranslate"><span class="pre">re.finditer()</span></code> to find all cases where our RegEx formula has matched in the <code class="docutils literal notranslate"><span class="pre">doc.text</span></code>. We iterate over each match and create a <code class="docutils literal notranslate"><span class="pre">Span</span></code> with the start and end character. If the user has enabled <code class="docutils literal notranslate"><span class="pre">context</span></code> searching, then we look for any term in their <code class="docutils literal notranslate"><span class="pre">context_list</span></code> to see if it appears in the given window they have established. If there is a match, then we append the <code class="docutils literal notranslate"><span class="pre">Span</span></code> to <code class="docutils literal notranslate"><span class="pre">new_ents</span></code>.</p>
<p>Our final section of code reads:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">new_ents</span><span class="p">:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">ent</span>
        <span class="n">new_ent</span> <span class="o">=</span> <span class="n">Span</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="n">original_ents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_ent</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">filter</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">filter_spans</span><span class="p">(</span><span class="n">original_ents</span><span class="p">)</span>
        <span class="n">final_ents</span> <span class="o">=</span> <span class="n">filtered</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_ents</span> <span class="o">=</span> <span class="n">new_ents</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">ents</span> <span class="o">=</span> <span class="n">final_ents</span>
    <span class="k">return</span> <span class="n">doc</span>
</pre></div>
</div>
<p>Here, we are iterating over each of our newly found matches. We then place the <code class="docutils literal notranslate"><span class="pre">new_ent</span></code> match into the <code class="docutils literal notranslate"><span class="pre">original_ents</span></code> list after assigning it the specified <code class="docutils literal notranslate"><span class="pre">label</span></code>. Finally, we filter the spans so that there are no overlapping entities.</p>
<p>Once complete, we reset the <code class="docutils literal notranslate"><span class="pre">doc.ents</span></code> to the <code class="docutils literal notranslate"><span class="pre">final_ents</span></code> and return the <code class="docutils literal notranslate"><span class="pre">doc</span></code> object back to the user.</p>
</section>
<section id="add-pipe-for-finding-streets">
<h2><span class="section-number">3.3.4. </span>Add Pipe for Finding Streets<a class="headerlink" href="#add-pipe-for-finding-streets" title="Permalink to this headline">#</a></h2>
<p>Let’s examine this function in practice by trying to find and extract all streets in a text. Because our data comes from Europe, we need to represent the way streets are represented in multiple languages. Let’s look at the example below where we use RegEx to find ways in which a street may appear in German (and Dutch) as well as English. Unlike English, German street names often contain the word street (strasse) as a compound in the street name. English, on the other hand, has many different ways to render the concept of a street both in abbreviated and full forms. RegEx is a perfect tool for working with this degree of variance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>

<span class="n">german_streets</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[A-Z][a-z]*(strasse|straße|straat)\b&quot;</span>
<span class="n">english_streets</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;([A-Z][a-z]* (Street|St|Boulevard|Blvd|Avenue|Ave|Road|Rd|Lane|Ln|Place|Pl)(\.)*)&quot;</span>
<span class="nd">@Language</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s2">&quot;find_streets&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find_streets</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">german_streets</span><span class="p">,</span> <span class="s2">&quot;STREET&quot;</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">english_streets</span><span class="p">,</span> <span class="s2">&quot;STREET&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_streets&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="s2">&quot;Berlinstrasse was a famous street. In America, many towns have a Main Street. It can also be spelled Main St.&quot;</span><span class="p">)</span>
<span class="n">displacy</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;ent&quot;</span><span class="p">,</span> <span class="n">jupyter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span class="tex2jax_ignore"><div class="entities" style="line-height: 2.5; direction: ltr">
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Berlinstrasse
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">STREET</span>
</mark>
 was a famous street. In 
<mark class="entity" style="background: #feca74; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    America
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">GPE</span>
</mark>
, many towns have a 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Main Street.
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">STREET</span>
</mark>
 It can also be spelled 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Main St.
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">STREET</span>
</mark>
</div></span></div></div>
</div>
</section>
<section id="creating-a-pipe-for-finding-ships">
<h2><span class="section-number">3.3.5. </span>Creating a Pipe for Finding Ships<a class="headerlink" href="#creating-a-pipe-for-finding-ships" title="Permalink to this headline">#</a></h2>
<p>Ships frequently appear in Holocaust documents. We could provide a list of ships to an EntityRuler, but finding one of these patterns isn’t enough. We want to ensure that the thing referenced is in fact a ship. Many of these terms could easily be toponyms, or entities that share the same spelling but mean different things in different contexts, e.g. the Ile de France, could easily be a GPE that refers to the area around Paris. General Hosey could easily be a PERSON. These are also known ships. To ensure toponym disambiguation, I set up several contextual clues, e.g. the list of nautical terms. If any of these words appear in area around the hit, then the heuristics assign that token the label of SHIP. If not, it ignores it and allows later pipes or the machine learning model to annotate it.</p>
<p>We can gather a list of known WWII ships from the WWII Database (https://ww2db.com/). One of the problems with the lists available here is that they are not utf-8 encoded. This means that the text is not normalized. Inside this repository is a csv file with a normalized version of these ship names. This CSV file also stores metadata about ships, namely their class, country of origin, and the year they were built.</p>
<p>In spaCy, we can store this metadata inside the entity Span container with a custom extension. This is done via a function known as a <code class="docutils literal notranslate"><span class="pre">getter</span></code> function that maps the data to the custom extension. Let’s see how this works in practice. We will use a synthetic sentence in which the <code class="docutils literal notranslate"><span class="pre">Activity</span></code>, a British vessel, is referenced as is <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">York</span></code>, a place as well as a US ship active during WWII.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ship_metadata_getter</span><span class="p">(</span><span class="n">ent</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/wwii-ships.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="o">==</span> <span class="s2">&quot;SHIP&quot;</span><span class="p">:</span>
        <span class="n">ship_name</span> <span class="o">=</span> <span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;The&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;the&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">ship_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">],</span> <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">country</span><span class="p">,</span> <span class="s2">&quot;year_built&quot;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">year</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/wwii-ships.csv&quot;</span><span class="p">)</span>

<span class="n">named_ships_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(The|the) (</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span>

<span class="nd">@Language</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s2">&quot;named_ships&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">named_ships</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">nautical</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ship&quot;</span><span class="p">,</span> <span class="s2">&quot;boat&quot;</span><span class="p">,</span> <span class="s2">&quot;sail&quot;</span><span class="p">,</span> <span class="s2">&quot;captain&quot;</span><span class="p">,</span> <span class="s2">&quot;sea&quot;</span><span class="p">,</span> <span class="s2">&quot;harbor&quot;</span><span class="p">,</span> <span class="s2">&quot;aboard&quot;</span><span class="p">,</span> <span class="s2">&quot;admiral&quot;</span><span class="p">,</span> <span class="s2">&quot;liner&quot;</span><span class="p">]</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">named_ships_pattern</span><span class="p">,</span> <span class="s2">&quot;SHIP&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context_list</span><span class="o">=</span><span class="n">nautical</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="o">==</span> <span class="s2">&quot;SHIP&quot;</span><span class="p">:</span>
            <span class="n">ent</span><span class="o">.</span><span class="n">set_extension</span><span class="p">(</span><span class="s1">&#39;ship_metadata&#39;</span><span class="p">,</span> <span class="n">getter</span><span class="o">=</span><span class="n">ship_metadata_getter</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;named_ships&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="s2">&quot;The Activity set sail from New York&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span><span class="p">,</span> <span class="n">ent</span><span class="o">.</span><span class="n">_</span><span class="o">.</span><span class="n">ship_metadata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The Activity SHIP {&#39;class&#39;: &#39;Activity-class Escort Carrier&#39;, &#39;country&#39;: &#39;United Kingdom&#39;, &#39;year_built&#39;: &#39;1942&#39;}
New York GPE False
</pre></div>
</div>
</div>
</div>
<p>There is a lot happening in this section of code, so let’s break down the different components here. The first function is our <code class="docutils literal notranslate"><span class="pre">getter</span></code> function: <code class="docutils literal notranslate"><span class="pre">ship_metadata_getter()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ship_metadata_getter</span><span class="p">(</span><span class="n">ent</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/wwii-ships.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="o">==</span> <span class="s2">&quot;SHIP&quot;</span><span class="p">:</span>
        <span class="n">ship_name</span> <span class="o">=</span> <span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;The&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;the&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">ship_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">],</span> <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">country</span><span class="p">,</span> <span class="s2">&quot;year_built&quot;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">year</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
<p>This function takes a single argument, the entity identified from the RegEx match. Here, we strip out the <code class="docutils literal notranslate"><span class="pre">The</span></code> from the entity’s name and check to see if the ship found appears in our dataset of known ships. We then isolate the ship’s metadata in the dataset and return that data as a dictionary.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/wwii-ships.csv&quot;</span><span class="p">)</span>

<span class="n">named_ships_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(The|the) (</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span>

<span class="nd">@Language</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s2">&quot;named_ships&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">named_ships</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">nautical</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ship&quot;</span><span class="p">,</span> <span class="s2">&quot;boat&quot;</span><span class="p">,</span> <span class="s2">&quot;sail&quot;</span><span class="p">,</span> <span class="s2">&quot;captain&quot;</span><span class="p">,</span> <span class="s2">&quot;sea&quot;</span><span class="p">,</span> <span class="s2">&quot;harbor&quot;</span><span class="p">,</span> <span class="s2">&quot;aboard&quot;</span><span class="p">,</span> <span class="s2">&quot;admiral&quot;</span><span class="p">,</span> <span class="s2">&quot;liner&quot;</span><span class="p">]</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">named_ships_pattern</span><span class="p">,</span> <span class="s2">&quot;SHIP&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">context_list</span><span class="o">=</span><span class="n">nautical</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="o">==</span> <span class="s2">&quot;SHIP&quot;</span><span class="p">:</span>
            <span class="n">ent</span><span class="o">.</span><span class="n">set_extension</span><span class="p">(</span><span class="s1">&#39;ship_metadata&#39;</span><span class="p">,</span> <span class="n">getter</span><span class="o">=</span><span class="n">ship_metadata_getter</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</pre></div>
</div>
<p>In this next section of code, we load up the dataset to construct our pattern of names to find via our RegEx function. As we iterate over each entity in our Doc container, we check to see if that entity’s label is a <code class="docutils literal notranslate"><span class="pre">SHIP</span></code>. If it is, then we set the extension of <code class="docutils literal notranslate"><span class="pre">ship_metadata</span></code> via the <code class="docutils literal notranslate"><span class="pre">getter</span></code> function referenced above.</p>
<p>Finally, we add our pipe to the spaCy pipeline and test the model with our constructed sentence.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;named_ships&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="s2">&quot;The Activity set sail from New York&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span><span class="p">,</span> <span class="n">ent</span><span class="o">.</span><span class="n">_</span><span class="o">.</span><span class="n">ship_metadata</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="create-pipe-for-identifying-a-military-personnel">
<h2><span class="section-number">3.3.6. </span>Create Pipe for Identifying a Military Personnel<a class="headerlink" href="#create-pipe-for-identifying-a-military-personnel" title="Permalink to this headline">#</a></h2>
<p>Military personnel are often referenced in English documents with their military rank. This means that we can use basic RegEx rules for finding and extracting those individuals. When we encounter a sequence of tokens that are capitalized after a military rank, we can make a fairly safe presumption that these tokens will be associated nominally with the rank. For this pipeline, we can again use WWII Database to isolate and grab all known military ranks during WWII for all countries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../data/military_ranks.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
<span class="n">military_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span><span class="si">}</span><span class="s2">)((?=\s[A-Z])(?:\s[A-Z][a-z\.]+)+)&quot;</span>
<span class="nd">@Language</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s2">&quot;find_military&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find_military</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">military_pattern</span><span class="p">,</span> <span class="s2">&quot;MILITARY&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_military&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="s2">&quot;Captain James T. Kirk commanded the ship.&quot;</span><span class="p">)</span>
<span class="n">displacy</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;ent&quot;</span><span class="p">,</span> <span class="n">jupyter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span class="tex2jax_ignore"><div class="entities" style="line-height: 2.5; direction: ltr">
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Captain James T. Kirk
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">MILITARY</span>
</mark>
 commanded the ship.</div></span></div></div>
</div>
</section>
<section id="create-pipe-for-identifying-spouses">
<h2><span class="section-number">3.3.7. </span>Create Pipe for Identifying Spouses<a class="headerlink" href="#create-pipe-for-identifying-spouses" title="Permalink to this headline">#</a></h2>
<p>Often times in historical documents the identity of people are referenced collectively. In some instances, such as those of spouses, this results in the name of the woman being attached to the name of her husband. The purpose of this SPOUSAL entity is to identify such constructs so that users can manipulate the output and reconstruct each individual singularly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>
<span class="n">spousal_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;((Mr|Mrs|Miss|Dr)(\.)* and (Mr|Mrs|Miss|Dr)(\.)*((?=\s[A-Z])(?:\s[A-Z][a-z\.]+)+))&quot;</span>
<span class="nd">@Language</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s2">&quot;find_spousal&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find_spousal</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">spousal_pattern</span><span class="p">,</span> <span class="s2">&quot;SPOUSAL&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_spousal&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="s2">&quot;Mr. and Mrs. Smith are going to the movie&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mr. and Mrs. Smith SPOUSAL
</pre></div>
</div>
</div>
</div>
</section>
<section id="creating-a-pipe-for-finding-ghettos">
<h2><span class="section-number">3.3.8. </span>Creating a Pipe for Finding Ghettos<a class="headerlink" href="#creating-a-pipe-for-finding-ghettos" title="Permalink to this headline">#</a></h2>
<p>In Holocaust documents, identifying ghettos can be difficult. Frequently a ghetto has the same name as the city in which it is found. To distinguish between the city and the ghetto, speakers and writers often specify that they are referencing the ghetto, not the city generally, by using the word “ghetto” in near proximity to the city name. The below pipe leverages this tendency by looking for capitalized words that precede the word “ghetto”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ghettos_pattern1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[A-Z]\w+((-| )*[A-Z]\w+)* (g|G)hetto&quot;</span>
<span class="n">ghettos_pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(g|G)hetto (of|in|at)((?=\s[A-Z])(?:\s[A-Z][a-z\.]+)+)&quot;</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>
<span class="nd">@Language</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s2">&quot;find_ghettos&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find_ghettos</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">ghettos_pattern1</span><span class="p">,</span> <span class="s2">&quot;GHETTO&quot;</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">ghettos_pattern2</span><span class="p">,</span> <span class="s2">&quot;GHETTO&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_ghettos&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="s2">&quot;The Warsaw Ghetto was in Poland. The ghetto at Warsaw.&quot;</span><span class="p">)</span>
<span class="n">displacy</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;ent&quot;</span><span class="p">,</span> <span class="n">jupyter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span class="tex2jax_ignore"><div class="entities" style="line-height: 2.5; direction: ltr">
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    The Warsaw Ghetto
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">GHETTO</span>
</mark>
 was in 
<mark class="entity" style="background: #feca74; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Poland
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">GPE</span>
</mark>
. The 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    ghetto at Warsaw.
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">GHETTO</span>
</mark>
</div></span></div></div>
</div>
</section>
<section id="creating-a-geography-pipe">
<h2><span class="section-number">3.3.9. </span>Creating a Geography Pipe<a class="headerlink" href="#creating-a-geography-pipe" title="Permalink to this headline">#</a></h2>
<p>Often in historical documents, the named geographic features of Europe are referenced. We can use both a list and a set of patterns to look for named mountains, forests, rivers, etc.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">general_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;([A-Z]\w+) (River|Mountain|Mountains|Forest|Forests|Sea|Ocean)*&quot;</span>
<span class="n">river_pattern</span> <span class="o">=</span> <span class="s2">&quot;(the|The) (Rhone|Volga|Danube|Ural|Dnieper|Don|Pechora|Kama|Oka|Belaya|Dniester|Rhine|Desna|Elbe|Donets|Vistula|Tagus|Daugava|Loire|Tisza|Ebro|Prut|Neman|Sava|Meuse|Kuban River|Douro|Mezen|Oder|Guadiana|Rhône|Kuma|Warta|Seine|Mureș|Northern Dvina|Vychegda|Drava|Po|Guadalquivir|Bolshoy Uzen|Siret|Maly Uzen|Terek|Olt|Vashka|Glomma|Garonne|Usa|Kemijoki|Great Morava|Moselle|Main 525|Torne|Dalälven|Inn|Maritsa|Marne|Neris|Júcar|Dordogne|Saône|Ume|Mur|Ångerman|Klarälven|Lule|Gauja|Weser|Kalix|Vindel River|Ljusnan|Indalsälven|Vltava|Ponoy|Ialomița|Onega|Somes|Struma|Adige|Skellefte|Tiber|Vah|Pite|Faxälven|Vardar|Shannon|Charente|Iskar|Tundzha|Ems|Tana|Scheldt|Timiș|Genil|Severn|Morava|Luga|Argeș|Ljungan|Minho|Venta|Thames|Drina|Jiu|Drin|Segura|Torne|Osam|Arda|Yantra|Kamchiya|Mesta)&quot;</span>

<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">)</span>

<span class="nd">@Language</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s2">&quot;find_geography&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find_geography</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">general_pattern</span><span class="p">,</span> <span class="s2">&quot;GEOGRAPHY&quot;</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">river_pattern</span><span class="p">,</span> <span class="s2">&quot;GEOGRAPHY&quot;</span><span class="p">)</span>    
    <span class="k">return</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_geography&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="s2">&quot;We entered the Black Forest and eventually walked to the Rhine.&quot;</span><span class="p">)</span>
<span class="n">displacy</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;ent&quot;</span><span class="p">,</span> <span class="n">jupyter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span class="tex2jax_ignore"><div class="entities" style="line-height: 2.5; direction: ltr">We entered the 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Black Forest
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">GEOGRAPHY</span>
</mark>
 and eventually walked to 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    the Rhine
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">GEOGRAPHY</span>
</mark>
.</div></span></div></div>
</div>
</section>
<section id="seeing-the-pipes-at-work">
<h2><span class="section-number">3.3.10. </span>Seeing the Pipes at Work<a class="headerlink" href="#seeing-the-pipes-at-work" title="Permalink to this headline">#</a></h2>
<p>Let’s now bring all this work together and assemble all our pipes into a single pipeline. We will disable the standard “ner” in this pipeline for now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_sm&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ner&quot;</span><span class="p">])</span>
<span class="n">camp_ruler</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;entity_ruler&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;camp_ruler&quot;</span><span class="p">)</span>
<span class="n">camp_ruler</span><span class="o">.</span><span class="n">add_patterns</span><span class="p">(</span><span class="n">camp_patterns</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_streets&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_spousal&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_ghettos&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_military&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;find_geography&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;named_ships&quot;</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="s2">&quot;ner&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/wjbmattingly/anaconda3/envs/python-textbook/lib/python3.9/site-packages/spacy/language.py:1895: UserWarning: [W123] Argument disable with value [&#39;ner&#39;] is used instead of [&#39;senter&#39;] as specified in the config. Be aware that this might affect other components in your pipeline.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;function __main__.named_ships(doc)&gt;
</pre></div>
</div>
</div>
</div>
<p>Now that we have compiled our pipeline, let’s test it. We will grab the raw text of a USHMM oral history testimony and process it through our pipeline. As we can see below, we were able to identify 3 different types of entities: <code class="docutils literal notranslate"><span class="pre">CAMP</span></code>, <code class="docutils literal notranslate"><span class="pre">GHETTO</span></code>, and <code class="docutils literal notranslate"><span class="pre">MILITARY</span></code>. We can also see the specific entities we grabbed. Note that the purpose of a heuristic pipeline is not to grab all entities, rather extract as many true positives as possible at the expense of missing a few examples. This can improve an overall pipeline that also leverages machine learning models. All 56 extracted entities are true positives.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://collections.ushmm.org/search/catalog/irn505576.json&quot;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">][</span><span class="s2">&quot;document&quot;</span><span class="p">][</span><span class="s2">&quot;fnd_content_web&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">)</span>
<span class="n">ent_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">ents</span><span class="p">]</span>
<span class="n">ent_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ent_types</span><span class="p">))</span>
<span class="n">ent_types</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found a Total of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">))</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ent_types</span><span class="p">)</span><span class="si">}</span><span class="s2"> categories: </span><span class="si">{</span><span class="n">ent_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">ents</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ent</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found a Total of 56 in 3 categories: [&#39;CAMP&#39;, &#39;GHETTO&#39;, &#39;MILITARY&#39;]
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Oberscharführer Gustav Wagner MILITARY
Sobibór CAMP
Sobibór CAMP
Oberscharführer Karl Frenzel MILITARY
Sobibór CAMP
Sobibor CAMP
Scharführer Hubert Gomerski MILITARY
Scharführer Michel MILITARY
Oberscharführer Hermann Michel MILITARY
Sobibór CAMP
Majdanek CAMP
Treblinka CAMP
Treblinka CAMP
Sobibór CAMP
Treblinka CAMP
Belzec CAMP
Belzec CAMP
Sobibór CAMP
Sobibór CAMP
Treblinka CAMP
Belzec CAMP
Untersturmführer Neumann MILITARY
Hauptscharführer Johann Niemann MILITARY
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Auschwitz CAMP
Auschwitz CAMP
Sobibór CAMP
Oberscharführer Gustav Wagner MILITARY
Sobibór CAMP
Scharführer Wolf MILITARY
Unterscharführer Franz Wolf MILITARY
Sobibor CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
ghetto in Helm GHETTO
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
Sobibor CAMP
Sobibór CAMP
Sobibór CAMP
Sobibór CAMP
</pre></div>
</div>
</div>
</div>
<p>This pipeline can now extract structured metadata from unstructured raw text. With heuristics like the ones above, we can construct fairly robust NLP pipelines that leverage lists of known entities as well as spaCy’s built in linguistic features to identify and extract useful and relevant from our text data. If we wanted to improve our pipeline, we could also train custom spaCy NER machine learning models, but this is beyond the scope of this book. With a strong basis in spaCy, however, and the plentiful resources available online, this should provide you with a good starting point to begin working with spaCy in your own projects.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./03_spacy"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="03_03_03_challenges.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">3.2. </span><center>The Challenges of Holocaust NER</center></p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../04_topic_modeling/04_01_01_intro.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">1. </span>Topic Modeling: Concepts and Theory</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By William J.B. Mattingly<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>